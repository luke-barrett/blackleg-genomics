#!/bin/bash
#SBATCH --job-name=run_fastqc
#SBATCH --time=00:30:00
#SBATCH --ntasks-per-node=2
#SBATCH --mem=10g

module load bwa

echo "module has loaded"

mkdir -p $OUT_DIR

IN_LIST=( $(tail -n +2 ${METADATA} | cut -f 1 | sed "s/_R[12].*//" | sort -u) );

echo "LIST has been created"

#this prints the METADATA file minus the first lines| cuts the first column (filename)| replaces _R1 or _R2 and identifiers with nothing (generates two files with same name) | and keeps only one copy of file
#so, IN_List uniquely identifies each pair of files (R1 and R2) and we then call this STEM

if [ ! -z "$SLURM_ARRAY_TASK_ID" ]
    then
            STEM=${IN_LIST["$SLURM_ARRAY_TASK_ID"]}
            SAMPLE=`grep "${STEM}" $METADATA | cut -f3` # sampleName 
            ID=`grep "${STEM}" $METADATA | cut -f3` # barcode column 2 metadata`
            DATE=`grep "${STEM}" $METADATA | cut -f12` # date column 12 metadata
            PLATFORM=`grep "${STEM}" $METADATA | cut -f13`# platform column 13 metadata
            LIBRARY="${SAMPLE}.${INDEX}.${DATE}" # join data to create new sample info
            CENTRE=`grep "${STEM}" $METADATA | cut -f10` # seq centre column 10 metadata
            SEQDATE=`grep "${STEM}" $METADATA | cut -f12` # seq date column 12
            UNIT=`grep "${STEM}" $METADATA | cut -f9` # seq lane column 9`
            echo "@RG\tID:${ID}\tCN:${CENTRE}\t"` \
                   `"DT:${DATE}\tLB:${LIBRARY}\t"` \
                   `"PL:${PLATFORM}\tPU:${UNIT}\tSM:${SAMPLE}" > $OUT_DIR/${STEM}.log
            if [ ! -f ${OUT_DIR}/${STEM}.sam ]
            then
                bwa mem ${GENOME} ${IN_DIR}/${STEM}*fq.gz \ 
                    -M \
                    -R "@RG\tID:${ID}\tCN:${CENTRE}\tDT:${SEQDATE}\tLB:${LIBRARY}\tPL:${PLATFORM}\tPU:${UNIT}\tSM:${SAMPLE}" > ${OUT_DIR}/${STEM}.sam 2>> $OUT_DIR/${STEM}.log
            fi
    else
        echo "Error: Missing array index as SLURM_ARRAY_TASK_ID"
fi
